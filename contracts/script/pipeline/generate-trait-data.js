/**
 * Generate TraitData.sol from image-data.json
 *
 * Reads the pipeline output and generates a Solidity library
 * that returns all trait data as bytes arrays for deployment.
 */

import fs from 'fs/promises';
import path from 'path';

const INPUT_FILE = './output/image-data.json';
const OUTPUT_FILE = '../TraitData.sol';

function base64ToHex(b64) {
  const buf = Buffer.from(b64, 'base64');
  return buf.toString('hex');
}

function generateTraitFunction(name, items) {
  const lines = [];
  lines.push(`    function getAll${name}() internal pure returns (bytes[] memory) {`);
  lines.push(`        bytes[] memory traits = new bytes[](${items.length});`);

  for (let i = 0; i < items.length; i++) {
    const hex = base64ToHex(items[i].data);
    // Empty traits (fully transparent) get a minimal 4-byte bounds header
    const safeHex = hex.length > 0 ? hex : '00000000';
    lines.push(`        traits[${i}] = hex"${safeHex}";`);
  }

  lines.push('        return traits;');
  lines.push('    }');
  return lines.join('\n');
}

function generatePaletteFunction(palette) {
  const lines = [];
  lines.push('    function getPalette() internal pure returns (string[] memory) {');
  lines.push(`        string[] memory colors = new string[](${palette.length});`);

  for (let i = 0; i < palette.length; i++) {
    lines.push(`        colors[${i}] = "${palette[i]}";`);
  }

  lines.push('        return colors;');
  lines.push('    }');
  return lines.join('\n');
}

function generateBackgroundsFunction(bgcolors) {
  const lines = [];
  lines.push('    function getBackgrounds() internal pure returns (string[] memory) {');
  lines.push(`        string[] memory colors = new string[](${bgcolors.length});`);

  for (let i = 0; i < bgcolors.length; i++) {
    lines.push(`        colors[${i}] = "${bgcolors[i]}";`);
  }

  lines.push('        return colors;');
  lines.push('    }');
  return lines.join('\n');
}

async function main() {
  console.log('=== Generate TraitData.sol ===\n');

  const raw = await fs.readFile(INPUT_FILE, 'utf8');
  const data = JSON.parse(raw);

  console.log(`Palette: ${data.palette.length} colors`);
  console.log(`Backgrounds: ${data.bgcolors.length}`);
  console.log(`Heads: ${data.images.heads.length}`);
  console.log(`Bodies: ${data.images.bodies.length}`);
  console.log(`Specs: ${data.images.specs.length}`);
  console.log(`Antennas: ${data.images.antennas.length}`);
  console.log(`Accessories: ${data.images.accessories.length}`);

  const sol = `// SPDX-License-Identifier: MIT
pragma solidity ^0.8.24;

/// @title TraitData
/// @notice Auto-generated trait data from pipeline output
/// @dev Generated by generate-trait-data.js — DO NOT EDIT MANUALLY
library TraitData {
${generatePaletteFunction(data.palette)}

${generateBackgroundsFunction(data.bgcolors)}

${generateTraitFunction('Heads', data.images.heads)}

${generateTraitFunction('Bodies', data.images.bodies)}

${generateTraitFunction('Specs', data.images.specs)}

${generateTraitFunction('Antenna', data.images.antennas)}

${generateTraitFunction('Accessories', data.images.accessories)}
}
`;

  await fs.writeFile(OUTPUT_FILE, sol);

  console.log(`\n✓ Generated ${OUTPUT_FILE}`);
  console.log(`  Palette: ${data.palette.length} colors`);
  console.log(`  Total traits: ${
    data.images.heads.length +
    data.images.bodies.length +
    data.images.specs.length +
    data.images.antennas.length +
    data.images.accessories.length
  }`);
}

main().catch(console.error);
